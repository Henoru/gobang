# ；五子棋

人工智能程序实验报告

**211502024 贺卓宇**

程序运行和游玩方法:
README.md

## 选题描述

五子棋是历史悠久益智棋类游戏，老少皆宜
选题实现了图形化的本地五子棋对战程序，采用了适合萌新的无禁手规则，并提供了玩家对战，人机对战和电脑互博等模式可供玩家选择。

第三阶段尝试实现基于自我博弈基础上训练的卷积神经网络。

## 第三阶段设计方案

### 模型构建

#### MCTS蒙特卡洛搜索树

蒙特卡洛搜索树原理在于按照一定规则双方在博弈树上轮流落子，最终按照走的步数最多的下法选择。

##### 蒙特卡洛树的随机落子规则：

$UCT(x)=Q+cP\sqrt{\frac{N_{fa}}{N_x+1}}$
变量解释:
$N:$经过该点的次数
$V:$胜利权重(走出胜利局面+1，局面-1)
$Q:\frac{V}{N}$表示点的价值 范围：$[-1,1]$
$P:$神经网络预测的走到子局面的概率
$c:$超参数，通常选取3~5
公式解释:
公式左边部分体现局面的价值，公式右边体现点的探索价值
既充分考虑已经走的点的好处又能兼顾探索新的局面

##### MCTS的运行流程一栏:

对于当前结点若已经拓展，则按照$UCT$公式选择最大的结点进行模拟

若没有进行拓展，则将当前局面输入进神经网络中，得到子结点的概率，然后继续通过$UCT$公式选择。

若已经分出胜负，则不断返回父节点，更新父节点的价值$Q$

在经过一定次数的模拟后，得到当前局面的子节点经过次数。在游玩过程中，将经过次数最多的作为ai选择的落子返回。在训练过程中，将经过的次数进行处理，作为当前局面生成概率的label加入数据集供之后的训练过程学习。

#### 神经网络构建

五子棋的局面优劣关键在于识别出棋型，而在各个部分识别棋型及其类似图象识别的提取特征过程。

因此在网络构建上仿照主流的卷积神经网络。

##### 网络

输入层:(4,15,15)
由棋盘黑子位置，棋盘白子位置，上次落子位置，当前执方类型组成的(4,15,15)网络

中间层：
由四层卷积层(卷积+ReLU)和一层全连接组成

输出层：(1,255)
分别代表棋盘上每个位置落子的概率

损失函数:采用了分类的概率损失函数

##### 数据处理

通过MCTS自我博弈得到(局面，概率)的数据集。
将局面按照输入合适处理后，形成数据集并供神经网络训练。

##### 数据扩展

由于MCTS耗时较长，并且由于五子棋的对称性，将每组数据均通过翻转和旋转等一系列变换拓展数据。

### 训练过程

将当前的模型通过自我博弈完成棋局。把每一步MCTS所收集的数据做成数据集并供神经网络训练。

神经网络训练后继续进行自我博弈的过程。

## 代码模块

```
src\ML
```

### 蒙特卡洛搜索树模块

```
src\ML\MCTS.py
```

#### 结点类

```python
class node:
  def __init__(self,fa,act,P,typ):
    '''
      fa:父节点;
      act:上一步落点;
      P此局面通过网络预测的概率;
      typ:当前执方
    '''
  def backup(self,v):
    '''
      返回结束局面的结果
      并修改当前结点的Q
    '''
  def select(self):
    '''
      按UCT规则返回最优秀的子节点
    '''
  def expand(self,B,net):
    '''
      拓展子节点，并将网络预测值赋予子节点
    '''
  def uct(self):
    '''
      计算结点的uct函数
    '''
```
#### 树类
```python
class MCTS:
  def __init__(self,net,MCTt=MCTSTIMES):
    '''
      net:网络
      MCTt:模拟次数
    '''
  def dfs(self,B_:board,node):
    '''
      返回列表表示局面和概率对
    '''
  def dfsForPlayer(self,B_:board,node):
    '''
      返回计算的落点
    '''
```
### 网络模块
```
src\ML\model.py
```
#### 网络类
```python
class CNN(nn.Module):
  def __init__(self):
    super(CNN,self).__init__()
    self.conv_1=nn.Sequential(
      nn.Conv2d(in_channels=4, out_channels=8, kernel_size=3, padding=0),
      nn.ReLU(),
    )
    self.conv_2=nn.Sequential(
      nn.Conv2d(in_channels=8, out_channels=64, kernel_size=3, padding=0),
      nn.ReLU(),
      nn.MaxPool2d(kernel_size=2),
    )
    self.conv_3=nn.Sequential(
      nn.Conv2d(64,256, 3, 1, 0),
      nn.ReLU(),
    )
    self.conv_4=nn.Sequential(
      nn.Conv2d(256,512, 3, 1, 0),
      nn.ReLU(),
    )
    self.out=nn.Sequential(
      nn.Linear(512,225),
      nn.Softmax(dim=1),
    )
  def forward(self,x):
    x=x.to(torch.float32)
    x=self.conv_1(x)
    x=self.conv_2(x)
    x=self.conv_3(x)
    x=self.conv_4(x)
    x = x.view(x.size(0), -1)
    x=self.out(x)
    return x
```
#### 局面转为输入层函数
```python
def transf(B,pos,typ):
  '''
    棋盘,上一步落子位置，当前执方
  '''
```
#### 数据集类
```python
class Mydata(Dataset):
  def __init__(self,data):
    self.data=data
  def __len__(self):
    return len(self.data)*8
  def __getitem__(self,index):
    n,m=index//8,index%8
    B,P,pos,typ=self.data[n]
    P=np.reshape(P,(15,15))
    blk=np.where(B.bd==board.BLACK,1,0)
    wht=np.where(B.bd==board.WHITE,1,0)
    epy=np.zeros((15,15))
    if pos[0]!=-1: 
      epy[pos[0]][pos[1]]=1
    if typ==1:
      T=np.zeros((15,15))
    else:
      T=np.ones((15,15))
    # flip
    if m%2:
      blk,wht,epy,P=np.flip(blk),np.flip(wht),np.flip(epy),np.flip(P)
    m/=2
    # identity
    input=np.concatenate([np.rot90(blk,m),np.rot90(wht,m),np.rot90(epy,m),T]).reshape((4,15,15))
    P=np.rot90(P,m)
    P=np.reshape(P,-1)
    return torch.from_numpy(input.copy()),torch.from_numpy(P.copy())
```
#### 训练函数
```python
def train(net,data):
  '''
    待训练网络
    未处理数据
  '''
```
#### 获取输出函数
```python
def calc(B:board,pos,typ,net):
 '''
  将给定局面转为输入层并通过网络获取输出
  再剔除输出中无效的点并返回
 '''
```
## 实现效果
由于机器限制和时间不足，网络仅经过三四盘的训练，因此在智能上和随机下并无区别，呜呜~
## Reference List
[AlphaZero实战：从零学下五子棋（附代码）
宋俊潇](https://zhuanlan.zhihu.com/p/32089487)
[一起来实现AlphaZero吧！AlphaZero实战篇](https://zhuanlan.zhihu.com/p/115867362)
[AlphaZero从入门到学废](https://zhuanlan.zhihu.com/p/436527860)